---
title: 大白话Paxos
tags:
  - paxos
categories:
  - consensus
date: 2018-06-13 09:35:29
---

# 大白话Paxos

网上有太多关于Paxos的解说，随手一搜出现一大把，该看哪个呢？好难选择一样，那我就记录一下自己的理解吧。先把大家都看到的概念罗列一下：
## 角色
- ** Client 产生提议者 **
>享受着上帝般的服务，成天指挥自己的小跟班Proposer跑断腿，把自己的想法送到Acceptor手上。

- ** Proposer 提议者 **
>一方面领着大Boss(Client)的任务，一方面去找相关部门（Acceptor），尽量完成任务。为什么不说一定完成任务呢？因为共识有可能无法达成，下回再试。来回几趟搞烦了就换个Boss！

- ** Acceptor 决策者 **
>就像相关部门的领导，比如正的、副的，一托四（为什么不托三呢？保持奇数，就这么简单）。又因为油水大，这些人不管正副谁也不服谁。要做成一件事必须开个研讨会进行表决，且超过半数同意！

- ** Learner 决策学习者 **
>中央领导，只听汇报

那么好几个有实力的大Boss竞标同一个项目时，必须会有各自派出自己的跟班去公关（手段多种多样，略过），跑断腿的小跟班也有可能换工作哦。


## 阶段、票
- **票（Ticket）**可以理解为大Boss派差事的编号，相关部门只接受最大的票号。那你肯定会想直接弄个最大的数，那直接玩完了。那就大Boss来看规章制度：
>只能从0开始累计
票号使用前必须得到半数以上领导批准
领导都会记录下自己批准的最大票号
批准的票号必须大于自己记下的最大票号
未获超半数领导批准的票号作废，再加1重试

- **阶段**的存在是因为办事要讲究流程，你得去去取号机拿个号，然后再等着每位领导会见。
**第一阶段：请求批准票号**
>Proposer请求Acceptor批准票号，合法的票号必须得到超半数Acceptor批准。
多个客户端竞争一个合法票号，即使竞争到了一个票号，如果你动作不够快就会过期。

  比如C1得到票号100，在C1还在送提案的路上时，C2得到票号101。当C1拿着100去提交提案时，领导们只接受票号101的提案了。

 **第二阶段：发送提案**
>Proposer向Acceptor提交提案，Acceptor只接受已批准、未过期票号的提案

 **第三阶段：执行提案**
>Proposer收到超半数Acceptor接受提案后，请求Acceptor执行自己的提案。
已接受的提案不会过期。

## 一本正经的简述
- 每个节点本地产生新的票号。
- 请求所有服务器批准票号。
- 服务器只批准大于最大已批准的新票号。
- 超半数服务器批准的票号成为合法票号，可以提交提案，否则从头来过。
- 服务器只接受未过期的合法票号的提案，过期的票号需要从头来过。
- 超半数服务器接受的提案可以请求执行，否则从头来过。
- 服务器只执行已接受的提案。

## 适用性
- **场景**
>强一致性的多机数据拷贝

- **服务器宕机**
>由于服务器存在宕机的可能，当一半的服务器宕机时无法达成共识。
服务器数量保持2x+1个是极好的。
当你需要知道“一半”实际应该是多少时，就应该事先知道总共有多少服务器（动态增减另外处理）。
那如果5台服务器中1台宕机，对于共识过程会不会出现总是2台同意，2台不同意？只要过程具有一定随机性，这种情况不会大面积出现。

- **共识失败**
>客户端需要写入数据前必须让所有服务器达成共识（超半数批准的票号，超半数接受的提案），那如果共识失败怎么办？只能重新尝试！依据不同的环境和性能，有可能持续失败N次。这就可能导致一个事务开启等待时间过长。
如果2个客户端不停地请求票号，操作速度基本一致，并且任一个客户端都无法获得超半数同意，那就玩不下去了。

## 相关项目
- Chubby
- ZooKeeper
- Nutanix
- [PhxPaxos](https://github.com/Tencent/phxpaxos)
- [libpaxos](https://bitbucket.org/sciascid/libpaxos)