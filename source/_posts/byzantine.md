---
title: 拜占庭笔记
tags:
  - byzantine
categories:
  - consensus
  - blockchain
date: 2018-06-15 10:15:23
---

## 拜占庭（Byzantine）
- 什么是拜占庭问题
>故事可以去某度某歌找，简单的说就是在一个不可信的、叛徒数量有限的环境中大家一起作出一致的、符合初衷的决定。

- 拜占庭节点
>所有节点N中撒谎、不按预定规则运行的恶意节点，称之为拜占庭节点F。反之，正常节点称之为非拜占庭节点。

## 拜占庭协定（Byzantine Agreement）
- 有效性
>最终决策值必须是某个节点的输入值，且必须是非拜占庭节点的值。

- 全部相同
>所以非拜占庭起始时使用相同的输入值v，决策值必须是v。

- 共识过程
> 
	1. 每个好节点都使用相同的输入值v=x（以下称提案），坏节点使用其他值v=~
	2. 每个节点发送自己的提案v
	3. 接收所有节点的提案，并整理成集合Sv，集合中没有包括自己的提案
	4. 每个节点再发送Sv
	5. 接收所有节点的Su
	6. 从所有Su和Sv中挑选至少在两个S中出现的提案
	7. 选择提案值最小的作为决策值
    
- 节点
>至少需要4个节点才能达成共识，拜占庭节点>=全部节点1/3时无法达成共识。
设定每个节点不能篡改提案中发送者的源地址。

## 拜占庭容错（PBFT）
- 阶段
>容错算法分为三个阶段：Pre-Prepare，Prepare，Commit

- 共识过程
> 
	1. Request: 客户端发送请求到任一节点
	2. Pre-Prepare: 节点广播客户端的请求到所有节点。
	3. Prepare: 节点收到广播的请求后记录并再次广播到所有节点（表示同意）。
	4. Commit: 节点收到一定数量表示同意的二次广播后，广播Commit请求到所有节点。
	5. Reply: 所有节点收到一定数量的Commit广播后向客户端反馈。
  
![image](/images/pbft.png)
- 推演
> 设v=1, v'=0，N=4：
F=0，所有节点都收到1111，共识为1
F=1，所有节点都收到三个1，一个0，共识为1
F=2，所有节点都收到两个1，两个0，共识失败
得: N >= 3F + 1，F < N/3