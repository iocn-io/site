---
title: 大白话Raft
tags: []
categories:
  - consensus
date: 2018-06-14 16:39:57
---

# 大白话Raft
## 角色
- **Follower**
>老百姓，和平时期老老实实耕地（接收来自Leader的数据，转发来自客户端的请求给Leader），动荡时期伺机造反。

- **Candidate**
>候选人，动荡时期参举办造反活动，砖治各种不服（投票）！

- **Leader**
>民选领袖，地位不稳，还得理万机（处理来自客户端的请求，保持心跳，同步数据）。

## 节点
- 最少需要3个节点
- n/2+ 1个节点同意达成共识
- 管理自己的Term
- 随机休眠

## 共识产生
- **从启动到竞选**
>节点在三种角色间变换身份，刚启动大家都是老百姓。
当老百姓发现没有领袖或领袖失去响应时，所有老百姓都转换为候选人准备竞选。
所有候选人投票(可以投自己)， 票数最多的节点当选为领袖(只能有一个领袖)， 落选节点都被贬为老百姓。

- **共识失败**
>当共识产生失败时，没有领袖胜出。每个候选人就地休息一阵子，具体休息多久自己随机决定。这个随机就会影响下一轮竞争的结果，说不定别人还在休息你就抢先开始投票了呢。在休息时只能将票投给来拉票的候选人，什么?你不休息?那不玩了，村规民约还是要有的!
比如每个人都把票投给自己，那么共识失败。
再比如9个节点，意见分成三大派系，各不相上下，那么共识失败。

- Term（任期）
>从帝国建立时起（网络启动时）为元年，每个节点都保存Term=1。每举行一次竞选Term都要加1，表示我们竞选下一届领袖。
比如共识失败、Leader失去心跳时、异常等情况时，Term+1后举行下一届竞选。
当前Leader或Candidate发现自己的Term比其他Follower要小时，节点转为Follower并将自己的Term加1。
Follower发现自己的Term比别的Follower要小时，更新自己的Term与其他节点保持一致。

- **权威**
>每一届只能有一个领袖，从此可用性、一致性都靠朕了，一人身系天下安危于万机不顾。

- **过程**
>每个Follower必须经过不同时间的随机等待后才能转为Candidate发起选举（Term+1），并向其他节点拉票。
获得超半数节点支持后当选为Leader，开始主持工作。
如果拉票时收到其他Candidate的拉票请求，并且Term比你大，转为Follower。否则保持Candidate状态并拒绝其他Candidate拉票。
选举必须在有限时间内结束，超时重选。
每一届选举每个节点只能投票一次。


## Leader节点
- 被强烈依懒的节点
>决定一段时间内网络可用性。如果领袖都不干了，整个网络无法正常处理请求，那就只能再选一个来上任后再去处理请求。

- 一致性的保证
>数据写入权限拥有者，数据一致性守护者，协议规定数据只能由Leader向Follower同步。

- 统治的方法
>Leader统治世界用的不是儒家，用的是心跳!对，没错，就是心跳! Leader每隔那么几秒钟就得告诉所有老百姓“朕，还活着!”。
当老百姓们一段时间没有收到Leader的心跳就会大喊“陛下驾崩了，国不可一日无君！”，朕的帝国就是这么拱手和让人的，总有刁民想害朕！

- 任期（Term）
>Raft的任期是受不限制的，俗话说“不作死就不会死”，只要朕能理万机，就能一直干到死！
如果有请求中的Term比朕的小，拒绝该请求。其他节点也应该保持Term是最新的，否则就是大不敬。

## 数据状态
- 权威
>所有客户端的请求必须经由Leader处理。

- 过程
>客户端向Leader提交数据后，收到的数据处理未提交状态。
Leader通知所有Follower复制数据，并且给出响应。
超半数Follower接受了数据并给出正确响应后，Leader向客户端表示数据已接受。
Leader向客户端发出响应时已经表明数据状态为已提交，同时告知所有Follower该数据已提交，放心吧！

- 状态
>客户无法将数据提交到Leader。
**Leader**在复制到Follower前出现故障，**未提交状态**。
**Leader**复制到所有Follower，未确认Follower响应。**未提交状态**，但所有Follower已经保持一致。新当选的Leader继续完成，客户端可重试。
**Leader**复制到部分Follower，未确认Follower响应。**未提交状态**，拥有最新数据的Follower当选为Leader完成数据提交，并保持数据一致性。
**Leader**收到数据并复制到所有Follower，Leader为**已提交状态**，Follower为**未提交状态**，Leader故障。新当选Leader继续完成，客户端可重试。
**Leader**收到数据，并且数据**已提交状态**，但未响应客户端。客户端重试，在处理好重复数据的情况下不影响一致性。